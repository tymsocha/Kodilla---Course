App.Models.File=Backbone.RelationalModel.extend({initialize:function(){this.set("type",this.type())},content:function(){return this.get("userContent")},setContent:function(e){this.set("userContent",e)},resetContent:function(){this.set("editorSession",!1),this.setContent(this.get("content"))},hardReset:function(){this.set({userContent:null},{silent:!0})},type:function(){return this.get("filename").split(".").pop()},name:function(){return this.get("filename").split(".").slice(0,-1).join(".")},open:function(){this.set("opened",!0)},close:function(){this.set("opened",!1)}}),App.Models.ExerciseFile=App.Models.File.extend({content:function(){return(this.isTesting()?this.get("resolution"):this.get("userContent"))||this.get("content")},isTesting:function(){return this.get("exercise").isTesting()},blobContent:function(){var e=this.content();return"css"==this.type()?e.replace(/url\("?'?(.*?)"?'?\)/g,function(e,t){return"/"==t[0]&&(t=top.location.origin+t),"url('"+t+"')"}):e},prepareUserContent:function(){this.get("userContent")||this.resetContent()},blob:function(){return this._blob||this.updateBlob(),this._blob},validationBlob:function(){return this._validationBlob||this.updateBlob(),this._validationBlob},resetBlob:function(){this._blob=null},hardReset:function(){this._super(),this.resetBlob()},lookupFile:function(e,t){var i=this.collection.findWhere({filename:e.attr(t)});if(i)return this.dependencies.add(i),e.attr("data-original-"+t,i.get("filename")),e.attr(t,i.blobUrl()),this.listenTo(i,"change:userContent",this.updateBlob),i},injectDependenciesToIframe:function(e){var t=this,i=e.contents();i.find("[src]").each(function(){t.lookupFile($(this),"src")}),i.find("[href]:not(a)").each(function(){var e=$(this),i=t.lookupFile(e,"href");i&&_.isMicrosoftBrowser()&&"link"==e.prop("tagName").toLowerCase()&&"stylesheet"==e.attr("rel").toLowerCase()&&$("<style>").html(i.content()).insertAfter(e)})},loadToIframe:function(e,t,i){if(i=i||$.noop,_.isMicrosoftBrowser()){var n=t?this.validationBlob():this.blob(),s=new FileReader;s.onload=function(){var t=e.get(0).contentWindow.document.open(n.type,"replace");t.write(this.result),t.close(),i()},s.readAsText(n)}else e.attr("src",t?this.validationUrl():this.blobUrl()).one("load",i);return e},validators:function(){var e=["userContent","verification","filename"];return this.isTesting()&&e.push("resolution"),[this.pick.apply(this,e)].concat(this.dependencies.invoke("pick",e))},blobUrl:function(){return this._blob||this.updateBlob(),this.get("url")},validationUrl:function(){return this._blob||this.updateBlob(),this.get("validation_url")},updateValidationBlob:function(e){var t=App.Templates("validationCode")({code:e});this._validationBlob=new Blob([t],{type:"text/html"}),this.set("validation_url",URL.createObjectURL(this._validationBlob))},stopListeningDependencies:function(){if(this.dependencies){var e=this;this.dependencies.each(function(t){e.stopListening(t)})}},updateBlob:function(){this._blob||(this.prepareUserContent(),this.listenTo(this,"change:userContent",this.updateBlob)),this.stopListeningDependencies();this.dependencies=new Backbone.Collection;var e=this.blobContent();this._blob=new Blob([e],{type:{html:"text/html",css:"text/css",js:"text/javascript"}[this.type()]}),this.set("url",URL.createObjectURL(this._blob)),"html"!=this.type()||this.isPlusExerciseFile()||this.updateValidationBlob(e)},isPlusExerciseFile:function(){return"plus"==this.get("exercise").get("exerciseType")}}),App.Services.Validator=Backbone.View.extend({initialize:function(e){var t=this;this.file=e,window.addEventListener("message",function(e){var i=JSON.parse(e.data),n=t.$iframe.get(0);n&&n.contentWindow==e.source&&(t[i.action]||$.noop).call(t,i)})},validationFinished:function(e){this.defer.resolve(e.messages),this.$iframe.remove()},validate:function(){return this.defer=$.Deferred(),this.$iframe=this.file.loadToIframe($("<iframe>"),!0).appendTo($("#validation-iframes")),this.iframe=this.$iframe.get(0),this.defer},iframeReady:function(){var e=this;this.file.injectDependenciesToIframe(this.$iframe),setTimeout(function(){e.iframe.contentWindow&&e.iframe.contentWindow.postMessage(JSON.stringify({filename:e.file.get("filename"),validators:e.file.validators()}),"*")},this.file.get("exercise").isTesting()?1e3:0)},changeWidth:function(e){this.$iframe.css("width",e.width+"px"),this.iframe.contentWindow.postMessage("changeWidth:"+e.width,"*")}}),App.Models.Exercise=Backbone.RelationalModel.extend({urlRoot:function(){return"/exercise/"+this.get("pathId")+"/"+this.get("courseId")+"/"+this.get("lessonId")+"/"},relations:[{type:Backbone.HasMany,key:"files",relatedModel:App.Models.ExerciseFile,collectionType:App.Collections.ExerciseFiles,reverseRelation:{key:"exercise"}}],isPresentation:function(){return!!this.get("presentation_url")},formatErrorMessage:function(e,t){var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return e=e.replace(/<c\>(.*?)<\/c\>/g,function(e,t){return"<c>"+t.replace(/[&<>"'\/]/g,function(e){return i[e]})+"</c>"}),this.files().size()<2?e:App.Templates("errorMessage")({filename:t,message:e})},validate:function(){if(this.isPresentation())return $.when();var e=this,t=[],i=$.Deferred();return $.when.apply(this,$.map(this.files().where({type:"html"}),function(i){return new App.Services.Validator(i).validate().then(function(i){t=t.concat($.map(i,function(t,i){return $.map(t,function(t){return e.formatErrorMessage(t,i)})}))})})).then(function(){i.resolve(t)}),i},setTesting:function(e){return this.testing=e,this.files().invoke("resetBlob"),this},isTesting:function(){return this.testing||!1},files:function(){return this.get("files")}}),App.Models.ProjectFileSync=Backbone.Model.extend({urlRoot:"/project-file",socket:window.socket}),App.Models.ProjectFile=App.Models.File.extend({initialize:function(e){this._super(e),this.resetContent()},save:function(){return this.set({content:this.get("userContent")||""}),this._super.apply(this,arguments)},changed:function(){},urlRoot:"/"+App.getLang()+"/project-file/",loadToIframe:function(e){e.attr("src",this.httpUrl()+"?"+Date.now())},httpUrl:function(){return"//project-"+this.get("project").id+"."+top.location.host+this.get("path")+"/"+this.get("filename")},toJSON:function(){return $.extend({project_id:this.get("project").id},this.pick("mime","filename","path","content"))},isUnsaved:function(){return this.isNew()||this.get("userContent")!=this.get("content")},close:function(){this._super(),this.resetContent()}}),App.Models.BootcampProjectReview=Backbone.RelationalModel.extend({urlRoot:"/"+App.getLang()+"/bootcamp-project-review/"}),App.Models.BootcampLinkReview=Backbone.RelationalModel.extend({urlRoot:"/"+App.getLang()+"/bootcamp-link-review/"}),App.Models.Project=Backbone.RelationalModel.extend({urlRoot:"/"+App.getLang()+"/project-data/",relations:[{type:Backbone.HasMany,key:"files",relatedModel:App.Models.ProjectFile,collectionType:App.Collections.ProjectFiles,reverseRelation:{key:"project"}},{type:Backbone.HasOne,key:"bootcamp_project_review",relatedModel:App.Models.BootcampProjectReview,reverseRelation:{key:"project",type:Backbone.HasOne}}],files:function(){return this.get("files")},toJSON:function(){return this.pick("id","name","description","visibility","fork_id","type")}}),App.Models.PlusExerciseProgress=Backbone.RelationalModel.extend({initialize:function(){this.get("progress")?this.progress=this.get("progress").split(","):this.progress=[],this.allCheckpoints=0;var e=this;setTimeout(function(){e.listenTo(e,"change:progress",e.saveProgress)},0)},url:function(){var e=this.get("exercise");return"/"+App.getLang()+"/plus-exercise/"+e.get("id")+"/progress/"+e.get("userId")},checked:function(e){this.checkIfChecked(e)||(this.progress.push(e),this.set("progress",this.progress.join(",")))},unchecked:function(e){if(this.checkIfChecked(e)){var t=this.progress.indexOf(e);this.progress.splice(t,1),this.set("progress",this.progress.join(","))}},saveProgress:function(e){this.countFinishedPercentage(),this.save()},countFinishedPercentage:function(){var e=0;this.allCheckpoints&&(e=this.progress.length/this.allCheckpoints*100,e=Math.round(e)),this.set("percentage",e),100==e?this.set("done",1):this.set("done",0)},setAllCheckpoints:function(e){this.allCheckpoints=e,this.countFinishedPercentage()},checkIfChecked:function(e){return this.progress.indexOf(e)>-1}}),App.Models.PlusExercise=App.Models.Exercise.extend({url:function(){return"/"+App.getLang()+"/plus-exercise/data/"+this.get("id")+"/"+this.get("userId")},relations:[{type:Backbone.HasMany,key:"files",relatedModel:App.Models.ExerciseFile,collectionType:App.Collections.ExerciseFiles,reverseRelation:{key:"exercise"}},{type:Backbone.HasMany,key:"pages",reverseRelation:{key:"exercise"}},{type:Backbone.HasOne,key:"progress",relatedModel:App.Models.PlusExerciseProgress,reverseRelation:{key:"exercise",type:Backbone.HasOne}}]}),App.Models.BootcampUserSubmoduleMessage=Backbone.Model.extend({urlRoot:"/"+App.getLang()+"/bootcamp-user-submodule-message/"}),App.Models.BootcampProjectReviewActivity=Backbone.Model.extend({initialize:function(e){this.set("bootcamp_project_review",App.BootcampProjectReviews.add(e.bootcamp_project_review))}}),App.Models.BootcampLinkReviewActivity=Backbone.Model.extend({initialize:function(e){this.set("bootcamp_link_review",App.BootcampLinkReviews.add(e.bootcamp_link_review))}}),App.Models.BootcampUserSubmoduleActivity=Backbone.Model.extend({initialize:function(e){if(!(e.activity instanceof Backbone.Model)){var t=new(Function.prototype.bind.call(this.types[e.activity_type]))(e.activity);this.set("activity",t)}},types:{bootcamp_user_submodule_messages:App.Models.BootcampUserSubmoduleMessage,bootcamp_project_review_activities:App.Models.BootcampProjectReviewActivity,bootcamp_link_review_activities:App.Models.BootcampLinkReviewActivity}});