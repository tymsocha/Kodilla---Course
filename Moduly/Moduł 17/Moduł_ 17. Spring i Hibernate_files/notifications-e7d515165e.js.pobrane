App.Views.NotificationsView=Backbone.View.extend({events:{click:"notificationHasClicked","click [data-notification-close-button]":"closeImmediately","click [data-notification-open]":"openImmediately"},initialize:function(){this.getContactDetails()},closeImmediately:function(){$("body").removeClass("notification-content--visible hide-callus-desc")},openImmediately:function(){$("body").addClass("notification-content--visible")},getContactDetails:function(){Cookies.get("activeCampaignContactId")&&Cookies.get("activeCampaignContactEmail")?$.ajax({url:"/"+App.getLang()+"/activeCampaign/contact",method:"GET",data:{id:Cookies.get("activeCampaignContactId"),email:Cookies.get("activeCampaignContactEmail")},success:function(i){var t=this.prepareContactData(i);this.getNotification(t)}.bind(this)}):this.getNotification({})},prepareContactData:function(i){return{visitedPages:this.getVisitedPages(i.actions),fields:this.getFields(i),tags:i.tags}},getFields:function(i){var t={EMAIL:i.email,NAME:i.name,PHONE:i.phone};for(var e in i.fields){var a=i.fields[e];t[a.perstag]=a.val}return t},getVisitedPages:function(i){var t=[];if(void 0!==i)for(var e=0;e<i.length;e++){var a,n=i[e].text;-1!==n.indexOf("Visited page")&&(a=n.split("- ")[1],-1===t.indexOf(a)&&t.push(a))}return t},getNotification:function(i){$.ajax({url:"/"+App.getLang()+"/notification",method:"POST",data:{visitedPages:i.visitedPages,fields:i.fields,tags:i.tags,path:window.location.pathname.substr(1),queryParams:App.GetQueryParams()},success:function(i){if(0===i.length)return!1;var t=$(this.el);this.notificationId=i.id,t.html(i.content),setTimeout(function(){$("body").addClass("notification-visible notification-content--visible hide-callus-desc"),$(window).width()>543&&window.fcWidget&&window.fcWidget.close()},3e3)}.bind(this)})},notificationHasClicked:function(){Cookies.set("notificationHasClicked_"+this.notificationId,!0,{expires:730,path:"/"})}});