App.Models.File=Backbone.RelationalModel.extend({initialize:function(){this.set("type",this.type())},content:function(){return this.get("userContent")},setContent:function(a){this.set("userContent",a)},resetContent:function(){this.setContent(this.get("content"))},hardReset:function(){this.set({userContent:null},{silent:!0})},type:function(){return this.get("filename").split(".").pop()},name:function(){return this.get("filename").split(".").slice(0,-1).join(".")},open:function(){this.set("opened",!0)},close:function(){this.set("opened",!1)}}),App.Models.ExerciseFile=App.Models.File.extend({content:function(){return(this.isTesting()?this.get("resolution"):this.get("userContent"))||this.get("content")},isTesting:function(){return this.get("exercise").isTesting()},blobContent:function(){var a=this.content();return"css"==this.type()?a.replace(/url\("?'?(.*?)"?'?\)/g,function(a,b){return"/"==b[0]&&(b=top.location.origin+b),"url('"+b+"')"}):a},prepareUserContent:function(){this.get("userContent")||this.resetContent()},blob:function(){return this._blob||this.updateBlob(),this._blob},validationBlob:function(){return this._validationBlob||this.updateBlob(),this._validationBlob},resetBlob:function(){this._blob=null},hardReset:function(){this._super(),this.resetBlob()},lookupFile:function(a,b){var c=this.collection.findWhere({filename:a.attr(b)});if(c)return this.dependencies.add(c),a.attr("data-original-"+b,c.get("filename")),a.attr(b,c.blobUrl()),this.listenTo(c,"change:userContent",this.updateBlob),c},injectDependenciesToIframe:function(a){var b=this,c=a.contents();c.find("[src]").each(function(){b.lookupFile($(this),"src")}),c.find("[href]:not(a)").each(function(){var a=$(this),c=b.lookupFile(a,"href");c&&_.isMicrosoftBrowser()&&"link"==a.prop("tagName").toLowerCase()&&"stylesheet"==a.attr("rel").toLowerCase()&&$("<style>").html(c.content()).insertAfter(a)})},loadToIframe:function(a,b,c){if(c=c||$.noop,_.isMicrosoftBrowser()){var d=b?this.validationBlob():this.blob(),e=new FileReader;e.onload=function(){var b=a.get(0).contentWindow.document.open(d.type,"replace");b.write(this.result),b.close(),c()},e.readAsText(d)}else a.attr("src",b?this.validationUrl():this.blobUrl()).one("load",c);return a},validators:function(){var a=["userContent","verification","filename"];return this.isTesting()&&a.push("resolution"),[this.pick.apply(this,a)].concat(this.dependencies.invoke("pick",a))},blobUrl:function(){return this._blob||this.updateBlob(),this.get("url")},validationUrl:function(){return this._blob||this.updateBlob(),this.get("validation_url")},updateValidationBlob:function(a){var b=App.Templates("validationCode")({code:a});this._validationBlob=new Blob([b],{type:"text/html"}),this.set("validation_url",URL.createObjectURL(this._validationBlob))},stopListeningDependencies:function(){if(this.dependencies){var a=this;this.dependencies.each(function(b){a.stopListening(b)})}},updateBlob:function(){this._blob||(this.prepareUserContent(),this.listenTo(this,"change:userContent",this.updateBlob)),this.stopListeningDependencies();var a={html:"text/html",css:"text/css",js:"text/javascript"};this.dependencies=new Backbone.Collection;var b=this.blobContent();this._blob=new Blob([b],{type:a[this.type()]}),this.set("url",URL.createObjectURL(this._blob)),"html"!=this.type()||this.isPlusExerciseFile()||this.updateValidationBlob(b)},isPlusExerciseFile:function(){return"plus"==this.get("exercise").get("exerciseType")}}),App.Services.Validator=Backbone.View.extend({initialize:function(a){var b=this;this.file=a,window.addEventListener("message",function(a){var c=JSON.parse(a.data),d=b.$iframe.get(0);d&&d.contentWindow==a.source&&(b[c.action]||$.noop).call(b,c)})},validationFinished:function(a){this.defer.resolve(a.messages),this.$iframe.remove()},validate:function(){return this.defer=$.Deferred(),this.$iframe=this.file.loadToIframe($("<iframe>"),!0).appendTo($("#validation-iframes")),this.iframe=this.$iframe.get(0),this.defer},iframeReady:function(){var a=this;this.file.injectDependenciesToIframe(this.$iframe),setTimeout(function(){a.iframe.contentWindow&&a.iframe.contentWindow.postMessage(JSON.stringify({filename:a.file.get("filename"),validators:a.file.validators()}),"*")},this.file.get("exercise").isTesting()?1e3:0)},changeWidth:function(a){this.$iframe.css("width",a.width+"px"),this.iframe.contentWindow.postMessage("changeWidth:"+a.width,"*")}}),App.Models.Exercise=Backbone.RelationalModel.extend({urlRoot:function(){return"/exercise/"+this.get("pathId")+"/"+this.get("courseId")+"/"+this.get("lessonId")+"/"},relations:[{type:Backbone.HasMany,key:"files",relatedModel:App.Models.ExerciseFile,collectionType:App.Collections.ExerciseFiles,reverseRelation:{key:"exercise"}}],isPresentation:function(){return!!this.get("presentation_url")},formatErrorMessage:function(a,b){var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return a=a.replace(/<c\>(.*?)<\/c\>/g,function(a,b){return"<c>"+b.replace(/[&<>"'\/]/g,function(a){return c[a]})+"</c>"}),this.files().size()<2?a:App.Templates("errorMessage")({filename:b,message:a})},validate:function(){if(this.isPresentation())return $.when();var a=this,b=[],c=$.Deferred();return $.when.apply(this,$.map(this.files().where({type:"html"}),function(c){var d=new App.Services.Validator(c);return d.validate().then(function(c){b=b.concat($.map(c,function(b,c){return $.map(b,function(b){return a.formatErrorMessage(b,c)})}))})})).then(function(){c.resolve(b)}),c},setTesting:function(a){return this.testing=a,this.files().invoke("resetBlob"),this},isTesting:function(){return this.testing||!1},files:function(){return this.get("files")}}),App.Models.ProjectFileSync=Backbone.Model.extend({urlRoot:"/project-file",socket:window.socket}),App.Models.ProjectFile=App.Models.File.extend({initialize:function(a){this._super(a),this.resetContent()},save:function(){return this.set({content:this.get("userContent")||""}),this._super.apply(this,arguments)},changed:function(){},urlRoot:"/"+App.getLang()+"/project-file/",loadToIframe:function(a){a.attr("src",this.httpUrl()+"?"+Date.now())},httpUrl:function(){return"//project-"+this.get("project").id+"."+top.location.host+this.get("path")+"/"+this.get("filename")},toJSON:function(){return $.extend({project_id:this.get("project").id},this.pick("mime","filename","path","content"))},isUnsaved:function(){return this.isNew()||this.get("userContent")!=this.get("content")},close:function(){this._super(),this.resetContent()}}),App.Models.BootcampProjectReview=Backbone.RelationalModel.extend({urlRoot:"/"+App.getLang()+"/bootcamp-project-review/"}),App.Models.BootcampLinkReview=Backbone.RelationalModel.extend({urlRoot:"/"+App.getLang()+"/bootcamp-link-review/"}),App.Models.Project=Backbone.RelationalModel.extend({urlRoot:"/"+App.getLang()+"/project-data/",relations:[{type:Backbone.HasMany,key:"files",relatedModel:App.Models.ProjectFile,collectionType:App.Collections.ProjectFiles,reverseRelation:{key:"project"}},{type:Backbone.HasOne,key:"bootcamp_project_review",relatedModel:App.Models.BootcampProjectReview,reverseRelation:{key:"project",type:Backbone.HasOne}}],files:function(){return this.get("files")},toJSON:function(){return this.pick("id","name","description","visibility","fork_id","type")}}),App.Models.PlusExerciseProgress=Backbone.RelationalModel.extend({initialize:function(){this.get("progress")?this.progress=this.get("progress").split(","):this.progress=[],this.allCheckpoints=0;var a=this;setTimeout(function(){a.listenTo(a,"change:progress",a.saveProgress)},0)},url:function(){var a=this.get("exercise");return"/"+App.getLang()+"/plus-exercise/"+a.get("id")+"/progress/"+a.get("userId")},checked:function(a){this.checkIfChecked(a)||(this.progress.push(a),this.set("progress",this.progress.join(",")))},unchecked:function(a){if(this.checkIfChecked(a)){var b=this.progress.indexOf(a);this.progress.splice(b,1),this.set("progress",this.progress.join(","))}},saveProgress:function(a){this.countFinishedPercentage(),this.save()},countFinishedPercentage:function(){var a=0;this.allCheckpoints&&(a=this.progress.length/this.allCheckpoints*100,a=Math.round(a)),this.set("percentage",a),100==a?this.set("done",1):this.set("done",0)},setAllCheckpoints:function(a){this.allCheckpoints=a,this.countFinishedPercentage()},checkIfChecked:function(a){return this.progress.indexOf(a)>-1}}),App.Models.PlusExercise=App.Models.Exercise.extend({url:function(){return"/"+App.getLang()+"/plus-exercise/data/"+this.get("id")+"/"+this.get("userId")},relations:[{type:Backbone.HasMany,key:"files",relatedModel:App.Models.ExerciseFile,collectionType:App.Collections.ExerciseFiles,reverseRelation:{key:"exercise"}},{type:Backbone.HasMany,key:"pages",reverseRelation:{key:"exercise"}},{type:Backbone.HasOne,key:"progress",relatedModel:App.Models.PlusExerciseProgress,reverseRelation:{key:"exercise",type:Backbone.HasOne}}]}),App.Models.BootcampUserSubmoduleMessage=Backbone.Model.extend({urlRoot:"/"+App.getLang()+"/bootcamp-user-submodule-message/"}),App.Models.BootcampProjectReviewActivity=Backbone.Model.extend({initialize:function(a){this.set("bootcamp_project_review",App.BootcampProjectReviews.add(a.bootcamp_project_review))}}),App.Models.BootcampLinkReviewActivity=Backbone.Model.extend({initialize:function(a){this.set("bootcamp_link_review",App.BootcampLinkReviews.add(a.bootcamp_link_review))}}),App.Models.BootcampUserSubmoduleActivity=Backbone.Model.extend({initialize:function(a){if(!(a.activity instanceof Backbone.Model)){var b=new(Function.prototype.bind.call(this.types[a.activity_type]))(a.activity);this.set("activity",b)}},types:{bootcamp_user_submodule_messages:App.Models.BootcampUserSubmoduleMessage,bootcamp_project_review_activities:App.Models.BootcampProjectReviewActivity,bootcamp_link_review_activities:App.Models.BootcampLinkReviewActivity}});